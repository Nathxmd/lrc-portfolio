---
let track = null;
let trackId = null;
let error = null;

try {
  const res = await fetch(`${Astro.url.origin}/api/spotify`);
  track = await res.json();
  
  // Extract ID from URL: https://open.spotify.com/track/5sdQOyqq2IDhvmx2lHOpwd
  if (track?.url) {
    const match = track.url.match(/track\/([a-zA-Z0-9]+)/);
    trackId = match ? match[1] : null;
  }
} catch (e: any) {
  error = e.message;
}
---

{track && track.name && trackId ? (
  <div class="spotify-container" id="spotify-widget">
    <div class="spotify-bar">
      <img src={track.cover} class="cover" alt={track.name} />

      <div class="info">
        <p class="title">{track.name}</p>
        <p class="artist">{track.artist}</p>
      </div>

      <button class="play-btn" type="button">
        ▶
      </button>
    </div>

    <div class="player-wrapper" style="display: none;">
      <iframe
        class="spotify-iframe"
        src={`https://open.spotify.com/embed/track/${trackId}?utm_source=generator`}
        width="100%"
        height="152"
        style="border-radius:12px; border:0;"
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        title="Spotify Player"
      ></iframe>
    </div>
  </div>
) : error ? (
  <p style="color: #ff6b6b;">Error loading Spotify: {error}</p>
) : !trackId ? (
  <p style="color: #ffd93d;">Could not extract track ID from Spotify URL</p>
) : (
  <p style="color: #999;">No recent songs found.</p>
)}

<script>
  if (typeof window !== 'undefined') {
    document.addEventListener('DOMContentLoaded', function() {
      const widget = document.getElementById('spotify-widget');
      if (!widget) return;

      const btn = widget.querySelector('.play-btn') as HTMLButtonElement;
      const wrapper = widget.querySelector('.player-wrapper') as HTMLElement;

      if (!btn || !wrapper) return;

      let isOpen = false;

      btn.addEventListener('click', function() {
        isOpen = !isOpen;
        
        if (isOpen) {
          wrapper.style.display = 'block';
          btn.textContent = '✕';
        } else {
          wrapper.style.display = 'none';
          btn.textContent = '▶';
        }
      });
    });
  }
</script>

<style>
  .spotify-container {
    width: 100%;
    max-width: 600px;
  }

  .spotify-bar {
    width: 100%;
    display: flex;
    align-items: center;
    background: rgba(29, 185, 84, 0.12);
    border: 1px solid rgba(29, 185, 84, 0.35);
    padding: 10px 14px;
    border-radius: 14px;
    backdrop-filter: blur(6px);
    gap: 14px;
    transition: 0.3s ease;
  }

  .spotify-bar:hover {
    background: rgba(29, 185, 84, 0.18);
    border-color: rgba(29, 185, 84, 0.5);
  }

  .cover {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
  }

  .info {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex: 1;
  }

  .title {
    font-size: 15px;
    font-weight: 600;
    color: white;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .artist {
    font-size: 13px;
    color: #d1d1d1;
    margin: 3px 0 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .play-btn {
    background: #1db954;
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    transition: 0.25s ease;
    padding-bottom: 2px;
  }

  .play-btn:hover {
    background: #1ed760;
    transform: scale(1.08);
  }

  .player-wrapper {
    width: 100%;
    margin-top: 10px;
  }
</style>